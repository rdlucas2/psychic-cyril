<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="js/vendor/modernizr-2.6.2.min.js"></script>
    <script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
    <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/v4.2.0/kinetic-v4.2.0.min.js" type="text/javascript"></script>

    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
        var socket = io.connect(window.location.hostname);
        var unique = "";

        var msgRecieved = "";
        var userRecieved = "";
        socket.on('user', function (data) {
            userRecieved = data["user"];
        });

        socket.on('sent', function (data) {
            msgRecieved = data["sent"];
            var scrollable = $('#main');
            var inner = $('#main > .inner');

            var atBottom = Math.abs(inner.offset().top) + scrollable.height() + scrollable.offset().top >= inner.outerHeight();

            inner.append('<div class="' + unique + 'message"><span class="' + unique + 'user">' + userRecieved + ' says: </span><span class="' + unique + 'sent">' + msgRecieved + '</span></div>')

            if (atBottom) {
                scrollable.animate({ scrollTop: inner.outerHeight() });
            }
        });

        var name = "";
        socket.on('loggedin', function (data) {
            name = data['loggedin'];
            var scrollable = $('#main');
            var inner = $('#main > .inner');

            var atBottom = Math.abs(inner.offset().top) + scrollable.height() + scrollable.offset().top >= inner.outerHeight();
            unique = Math.random();

            inner.append('<div class="' + unique + 'message"><span class="' + unique + 'user">' + name + '</span><span class="' + unique + 'sent"> has connected...</span></div>');

            if (atBottom) {
                scrollable.animate({ scrollTop: inner.outerHeight() });
            }
        });

        socket.on('duplicateNickname', function () {
            alert("Someone is already using that name!");
            socket.emit('set nickname', prompt('What is your nickname?'));
        });

        socket.on('connect', function () {
            socket.emit('set nickname', prompt('What is your nickname?'));
            socket.on('ready', function () {
                $("#SEND").click(function () {
                    if ($('#TEXT').val().substr(0, 2) == "/w") {
                        tname = $('#TEXT').val().split(" ", 2);
                        message = $('#TEXT').val().split(tname[1], 2)
                        pmu = tname[1];
                        socket.emit('private msg', { pm: message[1], pmu: pmu });
                        unique = Math.random();
                        var scrollable = $('#main');
                        var inner = $('#main > .inner');
                        var atBottom = Math.abs(inner.offset().top) + scrollable.height() + scrollable.offset().top >= inner.outerHeight();
                        inner.append('<div style="color:red" class="' + unique + 'message"><span class="' + unique + 'user">To ' + pmu + ': </span><span class="' + unique + 'sent">' + message[1] + '</span></div>')
                        if (atBottom) {
                            scrollable.animate({ scrollTop: inner.outerHeight() });
                        }

                    }
                    else {
                        socket.emit('msg', $("#TEXT").val());
                    }
                    unique = Math.random();
                    $('#TEXT').val("");
                });
                $('#TEXT').bind('keyup', function (e) {
                    if (e.keyCode === 13) { // 13 is enter key
                        if ($('#TEXT').val().substr(0, 2) == "/w") {
                            tname = $('#TEXT').val().split(" ", 2);
                            message = $('#TEXT').val().split(tname[1], 2)
                            pmu = tname[1];
                            socket.emit('private msg', { pm: message[1], pmu: pmu });
                            unique = Math.random();
                            var scrollable = $('#main');
                            var inner = $('#main > .inner');
                            var atBottom = Math.abs(inner.offset().top) + scrollable.height() + scrollable.offset().top >= inner.outerHeight();
                            inner.append('<div style="color:red" class="' + unique + 'message"><span class="' + unique + 'user">To ' + pmu + ': </span><span class="' + unique + 'sent">' + message[1] + '</span></div>')
                            if (atBottom) {
                                scrollable.animate({ scrollTop: inner.outerHeight() });
                            }

                        }
                        else {
                            socket.emit('msg', $("#TEXT").val());
                        }
                        unique = Math.random();
                        $('#TEXT').val("");
                    }
                });
            });
        });

        socket.on('disconnecting', function (data) {
            var scrollable = $('#main');
            var inner = $('#main > .inner');

            var atBottom = Math.abs(inner.offset().top) + scrollable.height() + scrollable.offset().top >= inner.outerHeight();

            inner.append('<div class="' + unique + 'message"><span class="' + unique + 'user">' + data['user'] + '</span><span class="' + unique + 'sent"> has disconnected...</span></div>');

            if (atBottom) {
                scrollable.animate({ scrollTop: inner.outerHeight() });
            }
        });

        socket.on('userlist', function (data) {
            $('#USERS').empty();
            $.each(data, function (key, value) {
                $('#USERS').append('<div><a href="#" class="' + key + '">' + key + '</a></div>');
            });
        });

        $('#USERS a').live("click", function (e) {
            e.preventDefault();
            pmu = $(this).text();
            pmf = name;
            socket.emit('private msg', { pm: prompt('Private Message to this user:'), pmu: pmu });
        });

        socket.on('for your eyes only', function (data) {
            msgRecieved = data["pm"];
            userRecieved = data["pmf"];
            var scrollable = $('#main');
            var inner = $('#main > .inner');

            var atBottom = Math.abs(inner.offset().top) + scrollable.height() + scrollable.offset().top >= inner.outerHeight();

            inner.append('<div style="color:red" class="' + unique + 'message"><span class="' + unique + 'user">' + userRecieved + ' whispers: </span><span class="' + unique + 'sent">' + msgRecieved + '</span></div>')

            if (atBottom) {
                scrollable.animate({ scrollTop: inner.outerHeight() });
            }
        });

    </script>
    <style type="text/css">
        /* Ryan Lucas Custom Styles */

        #outer {
            width: 800px;
            margin: 0 auto;
        }

        #inner {
            float: left;
        }

        #main {
            height: 220px;
            width: 800px;
            float: left;
            overflow: auto;
            word-wrap: break-word;
        }

        #USERS {
            overflow: auto;
            word-wrap: break-word;
        }

        #userouter {
            height: 220px;
            width: 200px;
            float: right;
            clear: both;
        }

        #TEXT {
            float: left;
            width: 580px;
            height: 220px;
        }

        #SEND {
            clear: both;
            float: right;
            margin: 10px 210px 0 0;
        }

        #canvas {
            width: 624px;
            height: 624px;
            overflow: hidden;
            background: url(/img/EmptyBoard.gif);
        }
    </style>
</head>
<body>
    <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

    <!-- Add your site or application content here -->
    <div id="canvas"></div>
    <div id="outer">
        <div id="inner">

            <div id="main">
                <div class="inner">
                    <div class="message">
                        <span class="user"></span><span class="sent"></span>
                    </div>
                </div>
            </div>

            <div id="userouter">
                <h4>Users:</h4>
                <div id="USERS"></div>
            </div>

            <textarea id="TEXT" name="text"></textarea>

            <input type="submit" value="Send" name="submit" id="SEND" />

            <script>
                function drawImage(imageObj) {
                    var stage = new Kinetic.Stage({
                        container: "canvas",
                        width: 624,
                        height: 624
                    });
                    var layer = new Kinetic.Layer();

                    // king
                    var wkingImg = new Kinetic.Image({
                        image: imageObj,
                        x: stage.getWidth() / 2 - 40 / 2,
                        y: stage.getHeight() / 2 - 40 / 2,
                        width: 40,
                        height: 40,
                        draggable: true,
                    });

                    // add cursor styling
                    wkingImg.on('mouseover', function () {
                        document.body.style.cursor = 'pointer';
                    });
                    wkingImg.on('mouseout', function () {
                        document.body.style.cursor = 'default';
                    });

                    wkingImg.on('dragend touchend', function () {
                        x = wkingImg.getPosition().x;
                        y = wkingImg.getPosition().y;
                        socket.emit('xy', { x: x, y: y });
                    });

                    socket.on('returnxy', function (data) {
                        x = data["x"];
                        y = data["y"];
                        wkingImg.setPosition(x, y);
                        console.log(x + ", " + y);
                        layer.add(wkingImg);
                        stage.add(layer);
                        return false;
                    });

                    layer.add(wkingImg);
                    stage.add(layer);
                }
                var imageObj = new Image();
                imageObj.onload = function () {
                    drawImage(this);
                };
                imageObj.src = 'img/wking.gif';
            </script>

        </div>
    </div>
</body>
</html>
